<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業 PDF 轉檔工具 (真實版)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- PDF.js (用於讀取 PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- PptxGenJS (用於生成 PPT) -->
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <!-- Docx.js (用於生成 Word) -->
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    
    <script>
        // 設定 PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }

        .drop-zone {
            transition: all 0.3s ease;
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%234F46E5FF' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
        
        .drop-zone.active {
            background-color: #eef2ff;
            transform: scale(1.02);
        }

        @keyframes progress-stripes {
            from { background-position: 1rem 0; }
            to { background-position: 0 0; }
        }
        .animate-stripes {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
            animation: progress-stripes 1s linear infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { FileText, Upload, CheckCircle, FileOutput, X, RefreshCw, FileType, ArrowRight, Download, AlertCircle, Loader2 } = lucide;

        const App = () => {
            const [file, setFile] = useState(null);
            const [isDragging, setIsDragging] = useState(false);
            const [targetFormat, setTargetFormat] = useState('pptx'); // 預設 PPT
            const [status, setStatus] = useState('idle'); // idle, converting, finished, error
            const [progress, setProgress] = useState(0);
            const [progressText, setProgressText] = useState('');
            const [convertedBlob, setConvertedBlob] = useState(null);
            const fileInputRef = useRef(null);

            // Handle Drag Events
            const onDragOver = (e) => {
                e.preventDefault();
                setIsDragging(true);
            };

            const onDragLeave = (e) => {
                e.preventDefault();
                setIsDragging(false);
            };

            const onDrop = (e) => {
                e.preventDefault();
                setIsDragging(false);
                const droppedFile = e.dataTransfer.files[0];
                validateAndSetFile(droppedFile);
            };

            const onFileSelect = (e) => {
                const selectedFile = e.target.files[0];
                validateAndSetFile(selectedFile);
            };

            const validateAndSetFile = (file) => {
                if (!file) return;

                if (file.type !== 'application/pdf') {
                    alert('請上傳 PDF 格式的檔案！');
                    return;
                }

                // 限制 50MB
                const maxSize = 50 * 1024 * 1024; 
                if (file.size > maxSize) {
                    alert('檔案過大！請上傳小於 50MB 的 PDF 文件。');
                    return;
                }

                setFile(file);
                setStatus('idle');
                setProgress(0);
                setConvertedBlob(null);
                setProgressText('');
            };

            // --- 真實轉換核心邏輯 ---
            const startConversion = async () => {
                if (!file) return;

                setStatus('converting');
                setProgress(0);
                setProgressText('正在讀取 PDF...');

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    const totalPages = pdf.numPages;

                    if (targetFormat === 'pptx') {
                        // --- PDF 轉 PPTX (圖像化模式，保持排版) ---
                        const pres = new PptxGenJS();
                        pres.layout = 'LAYOUT_16x9'; 

                        for (let i = 1; i <= totalPages; i++) {
                            setProgressText(`正在處理第 ${i} / ${totalPages} 頁...`);
                            setProgress(Math.round(((i - 1) / totalPages) * 100));

                            const page = await pdf.getPage(i);
                            
                            // 設置較高的縮放比例以確保圖片清晰
                            const scale = 2.0; 
                            const viewport = page.getViewport({ scale });
                            
                            // 創建 Canvas 渲染 PDF
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;

                            await page.render({
                                canvasContext: context,
                                viewport: viewport
                            }).promise;

                            // 將 Canvas 轉為圖片 Data URL
                            const imgData = canvas.toDataURL('image/jpeg', 0.8);

                            // 加入 PPT 投影片
                            const slide = pres.addSlide();
                            // 計算比例以適應 PPT
                            slide.addImage({ 
                                data: imgData, 
                                x: 0, 
                                y: 0, 
                                w: '100%', 
                                h: '100%',
                                sizing: { type: 'contain', w: '100%', h: '100%' }
                            });
                        }

                        setProgressText('正在生成 PPT 檔案...');
                        const blob = await pres.write("blob");
                        setConvertedBlob(blob);

                    } else if (targetFormat === 'docx') {
                        // --- PDF 轉 DOCX (文字提取模式) ---
                        let fullText = "";
                        const { Document, Packer, Paragraph, TextRun } = docx;
                        const docChildren = [];

                        for (let i = 1; i <= totalPages; i++) {
                            setProgressText(`正在提取第 ${i} / ${totalPages} 頁文字...`);
                            setProgress(Math.round(((i - 1) / totalPages) * 100));

                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            
                            docChildren.push(
                                new Paragraph({
                                    children: [new TextRun({ text: `--- 第 ${i} 頁 ---`, bold: true, break: 1 })],
                                })
                            );
                            docChildren.push(
                                new Paragraph({
                                    children: [new TextRun(pageText)],
                                })
                            );
                            docChildren.push(new Paragraph({ text: "" })); // 空行
                        }

                        const doc = new Document({
                            sections: [{
                                properties: {},
                                children: docChildren,
                            }],
                        });

                        setProgressText('正在生成 Word 檔案...');
                        const blob = await Packer.toBlob(doc);
                        setConvertedBlob(blob);
                    }

                    setProgress(100);
                    setStatus('finished');

                } catch (error) {
                    console.error(error);
                    alert("轉換發生錯誤：" + error.message);
                    setStatus('idle');
                }
            };

            const reset = () => {
                setFile(null);
                setStatus('idle');
                setProgress(0);
                setConvertedBlob(null);
                if(fileInputRef.current) fileInputRef.current.value = '';
            };

            const handleDownload = () => {
                if (!convertedBlob) return;

                const url = URL.createObjectURL(convertedBlob);
                const a = document.createElement('a');
                a.href = url;
                const extension = targetFormat;
                a.download = `${file.name.replace('.pdf', '')}_converted.${extension}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            useEffect(() => {
                lucide.createIcons();
            }, [status, file, isDragging]);

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4">
                    
                    {/* Header */}
                    <header className="mb-10 text-center">
                        <div className="flex items-center justify-center mb-4">
                            <div className="bg-indigo-600 p-3 rounded-xl shadow-lg">
                                <i data-lucide="file-type" className="text-white w-8 h-8"></i>
                            </div>
                        </div>
                        <h1 className="text-3xl font-bold text-gray-800 mb-2">雲端 PDF 轉檔神器 (真實版)</h1>
                        <p className="text-gray-500">真正的瀏覽器端運算：PDF 轉 PPT (圖片模式) 或 Word (文字模式)</p>
                    </header>

                    {/* Main Card */}
                    <main className="bg-white w-full max-w-xl rounded-3xl shadow-2xl overflow-hidden transition-all duration-300">
                        
                        {/* 1. Upload View */}
                        {!file && (
                            <div 
                                className={`p-10 text-center cursor-pointer min-h-[400px] flex flex-col items-center justify-center ${isDragging ? 'bg-indigo-50' : ''}`}
                                onDragOver={onDragOver}
                                onDragLeave={onDragLeave}
                                onDrop={onDrop}
                                onClick={() => fileInputRef.current.click()}
                            >
                                <input 
                                    type="file" 
                                    className="hidden" 
                                    accept=".pdf" 
                                    ref={fileInputRef}
                                    onChange={onFileSelect}
                                />
                                <div className={`w-24 h-24 mb-6 rounded-full flex items-center justify-center transition-all duration-300 ${isDragging ? 'bg-indigo-200 scale-110' : 'bg-indigo-50'}`}>
                                    <i data-lucide="upload" className={`w-10 h-10 ${isDragging ? 'text-indigo-700' : 'text-indigo-500'}`}></i>
                                </div>
                                <h3 className="text-xl font-semibold text-gray-800 mb-2">
                                    {isDragging ? '放開以開始上傳' : '點擊或拖放 PDF 至此'}
                                </h3>
                                <p className="text-sm text-gray-400">支援最大 50MB 的 PDF 文件</p>
                            </div>
                        )}

                        {/* 2. File Selected / Converting View */}
                        {file && status !== 'finished' && (
                            <div className="p-8">
                                {/* File Info */}
                                <div className="flex items-center justify-between bg-gray-50 p-4 rounded-xl mb-8 border border-gray-100">
                                    <div className="flex items-center space-x-4">
                                        <div className="bg-red-100 p-3 rounded-lg text-red-600">
                                            <i data-lucide="file-text" className="w-6 h-6"></i>
                                        </div>
                                        <div className="text-left">
                                            <p className="font-semibold text-gray-700 truncate max-w-[200px]">{file.name}</p>
                                            <p className="text-xs text-gray-400">{(file.size / 1024 / 1024).toFixed(2)} MB</p>
                                        </div>
                                    </div>
                                    {status === 'idle' && (
                                        <button onClick={reset} className="p-2 hover:bg-gray-200 rounded-full text-gray-400 transition">
                                            <i data-lucide="x" className="w-5 h-5"></i>
                                        </button>
                                    )}
                                </div>

                                {/* Options */}
                                {status === 'idle' && (
                                    <div className="space-y-6">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-600 mb-3">選擇輸出格式</label>
                                            <div className="grid grid-cols-2 gap-4">
                                                <button 
                                                    onClick={() => setTargetFormat('docx')}
                                                    className={`flex flex-col items-center justify-center space-y-1 p-4 rounded-xl border-2 transition-all ${targetFormat === 'docx' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200 hover:border-gray-300 text-gray-600'}`}
                                                >
                                                    <div className="flex items-center space-x-2">
                                                        <i data-lucide="file-text" className="w-5 h-5"></i>
                                                        <span className="font-medium">Word</span>
                                                    </div>
                                                    <span className="text-xs opacity-70">(僅文字提取)</span>
                                                </button>
                                                <button 
                                                    onClick={() => setTargetFormat('pptx')}
                                                    className={`flex flex-col items-center justify-center space-y-1 p-4 rounded-xl border-2 transition-all ${targetFormat === 'pptx' ? 'border-orange-500 bg-orange-50 text-orange-700' : 'border-gray-200 hover:border-gray-300 text-gray-600'}`}
                                                >
                                                    <div className="flex items-center space-x-2">
                                                        <i data-lucide="file-output" className="w-5 h-5"></i>
                                                        <span className="font-medium">PowerPoint</span>
                                                    </div>
                                                    <span className="text-xs opacity-70">(高保真圖片)</span>
                                                </button>
                                            </div>
                                        </div>

                                        <button 
                                            onClick={startConversion}
                                            className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center space-x-2"
                                        >
                                            <span>開始真實轉換</span>
                                            <i data-lucide="arrow-right" className="w-5 h-5"></i>
                                        </button>
                                    </div>
                                )}

                                {/* Progress Bar */}
                                {status === 'converting' && (
                                    <div className="mt-8 text-center">
                                        <div className="flex justify-center mb-4">
                                            <i data-lucide="loader-2" className="w-8 h-8 text-indigo-600 animate-spin"></i>
                                        </div>
                                        <div className="h-4 w-full bg-gray-100 rounded-full overflow-hidden mb-4">
                                            <div 
                                                className="h-full bg-indigo-500 animate-stripes transition-all duration-300"
                                                style={{ width: `${progress}%` }}
                                            ></div>
                                        </div>
                                        <p className="text-indigo-600 font-medium">
                                            {progressText}
                                        </p>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* 3. Finished View */}
                        {status === 'finished' && (
                            <div className="p-10 text-center">
                                <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <i data-lucide="check-circle" className="w-10 h-10 text-green-600"></i>
                                </div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">轉換成功！</h2>
                                <p className="text-gray-500 mb-8">您的 {targetFormat.toUpperCase()} 檔案已生成</p>

                                <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-8 flex items-center justify-center space-x-3">
                                    <span className="font-mono text-gray-600 text-sm">
                                        {file.name.replace('.pdf', '')}_converted.{targetFormat}
                                    </span>
                                </div>
                                
                                <div className="space-y-3">
                                    <button 
                                        onClick={handleDownload}
                                        className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex items-center justify-center space-x-2"
                                    >
                                        <i data-lucide="download" className="w-5 h-5"></i>
                                        <span>下載真實檔案</span>
                                    </button>
                                    
                                    <button 
                                        onClick={reset}
                                        className="w-full bg-white hover:bg-gray-50 text-gray-600 font-medium py-3 rounded-xl border border-gray-200 transition-all flex items-center justify-center space-x-2"
                                    >
                                        <i data-lucide="refresh-cw" className="w-4 h-4"></i>
                                        <span>轉換其他文件</span>
                                    </button>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Footer / Disclaimer */}
                    <footer className="mt-8 text-center max-w-md">
                        <div className="flex items-start justify-center space-x-2 text-xs text-gray-400 bg-white/50 p-3 rounded-lg">
                            <i data-lucide="alert-circle" className="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                            <p className="text-left">
                                技術說明：本工具使用瀏覽器端運算。PPT 轉換採用「頁面截圖」技術，可完美保留排版，但內容為圖片不可編輯。Word 轉換則僅能提取純文字。
                            </p>
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
